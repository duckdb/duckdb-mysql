# name: test/sql/query_params_mariadb.test
# description: Test mysql_query with parameters
# group: [sql]

require mysql_scanner

require-env MYSQL_TEST_DATABASE_AVAILABLE

# CAST(? AS SIGNED) type is different on MariaDB
require-env MARIADB_SERVER

statement ok
ATTACH 'host=localhost user=root port=0 database=mysqlscanner' AS s (TYPE MYSQL_SCANNER)

query II
SELECT *, typeof(col1) FROM mysql_query('s',
  'SELECT ? col1',
  params=row(NULL))
----
NULL	VARCHAR

# numbers

query III
SELECT *, typeof(col1) FROM mysql_query('s',
  'SELECT CAST(? AS SIGNED) col1, CAST(? AS SIGNED) col2',
  params=row(TRUE, FALSE))
----
1	0	INTEGER

query IIII
SELECT *, typeof(col1) FROM mysql_query('s',
  'SELECT CAST(? AS SIGNED) col1, CAST(? AS SIGNED) col2, CAST(? AS SIGNED) col3',
  params=row(42::TINYINT, -127::TINYINT, 127::TINYINT))
----
42	-127	127	INTEGER

query IIII
SELECT *, typeof(col1) FROM mysql_query('s',
  'SELECT CAST(? AS UNSIGNED) col1, CAST(? AS UNSIGNED) col2, CAST(? AS UNSIGNED) col3',
  params=row(42::UTINYINT, 0::UTINYINT, 255::UTINYINT))
----
42	0	255	UINTEGER

query IIII
SELECT *, typeof(col1) FROM mysql_query('s',
  'SELECT CAST(? AS SIGNED) col1, CAST(? AS SIGNED) col2, CAST(? AS SIGNED) col3',
  params=row(42::SMALLINT, -32767::SMALLINT, 32767::SMALLINT))
----
42	-32767	32767	INTEGER

query IIII
SELECT *, typeof(col1) FROM mysql_query('s',
  'SELECT CAST(? AS UNSIGNED) col1, CAST(? AS UNSIGNED) col2, CAST(? AS UNSIGNED) col3',
  params=row(42::USMALLINT, 0::USMALLINT, 65535::USMALLINT))
----
42	0	65535	UINTEGER

query IIII
SELECT *, typeof(col1) FROM mysql_query('s',
  'SELECT CAST(? AS SIGNED) col1, CAST(? AS SIGNED) col2, CAST(? AS SIGNED) col3',
  params=row(42::INTEGER, -2147483647::INTEGER, 2147483647::INTEGER))
----
42	-2147483647	2147483647	INTEGER

query IIII
SELECT *, typeof(col1) FROM mysql_query('s',
  'SELECT CAST(? AS UNSIGNED) col1, CAST(? AS UNSIGNED) col2, CAST(? AS UNSIGNED) col3',
  params=row(42::UINTEGER, 0::UINTEGER, 4294967295::UINTEGER))
----
42	0	4294967295	UINTEGER

# query IIII
# SELECT *, typeof(col1) FROM mysql_query('s',
#  'SELECT CAST(? AS SIGNED) col1, CAST(? AS SIGNED) col2, CAST(? AS SIGNED) col3',
#  params=row(42::BIGINT, -9223372036854775807::BIGINT, 9223372036854775807::BIGINT))
#----
#42	-9223372036854775807	9223372036854775807	BIGINT

# query IIII
# SELECT *, typeof(col1) FROM mysql_query('s',
#  'SELECT CAST(? AS UNSIGNED) col1, CAST(? AS UNSIGNED) col2, CAST(? AS UNSIGNED) col3',
#  params=row(42::UBIGINT, 0::UBIGINT, 18446744073709551615::UBIGINT))
#----
#42	0	18446744073709551615	UBIGINT

query IIII
SELECT *, typeof(col1) FROM mysql_query('s',
  'SELECT CAST(? AS FLOAT) col1, CAST(? AS FLOAT) col2, CAST(? AS FLOAT) col3',
  params=row(42::FLOAT, 0::FLOAT, 42.123::FLOAT))
----
42	0	42.123	FLOAT

query IIII
SELECT *, typeof(col1) FROM mysql_query('s',
  'SELECT CAST(? AS DOUBLE) col1, CAST(? AS DOUBLE) col2, CAST(? AS DOUBLE) col3',
  params=row(42::DOUBLE, 0::DOUBLE, 42.123::DOUBLE))
----
42	0	42.123	DOUBLE

# dates

query IIII
SELECT *, typeof(col1) FROM mysql_query('s',
  'SELECT CAST(? AS DATE) col1, CAST(? AS DATE) col2, CAST(? AS DATE) col3',
  params=row('2020-12-31'::DATE, '1970-01-01'::DATE, '0001-01-01'::DATE))
----
2020-12-31	1970-01-01	0001-01-01	DATE

statement ok
SET mysql_time_as_time = TRUE

# TODO: check fractional part
query III
SELECT *, typeof(col1) FROM mysql_query('s',
  'SELECT CAST(? AS TIME) col1, CAST(? AS TIME) col2',
  params=row('12:34:56.123'::TIME, '00:00:01'::TIME))
----
12:34:56	00:00:01	TIME

statement ok
SET mysql_time_as_time = FALSE

query II
SELECT *, typeof(col1) FROM mysql_query('s',
  'SELECT CAST(? AS DATETIME) col1',
  params=row('2020-12-31 12:34:56.123'::TIMESTAMP))
----
2020-12-31 12:34:56	TIMESTAMP

# varchar

query II
SELECT *, typeof(col1) FROM mysql_query('s',
  'SELECT ? col1',
  params=row('foo'::VARCHAR))
----
foo	VARCHAR

query II
SELECT *, typeof(col1) FROM mysql_query('s',
  'SELECT ? col1',
  params=row('01234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789'::VARCHAR))
----
01234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789	VARCHAR

statement ok
PREPARE p1 as SELECT * from mysql_query('s', 'SELECT CONCAT(?, ?) a', params=row(?, ?))

query I
EXECUTE p1('foo', 'bar')
----
foobar

query I
EXECUTE p1('baz', 'boo')
----
bazboo

statement ok
DEALLOCATE p1

statement error
SELECT * FROM mysql_query('s', 'SELECT ? col1',  params=NULL)
----
Binder Error: Parameters to mysql_query cannot be NULL

statement error
SELECT * FROM mysql_query('s', 'SELECT ? col1',  params=42)
----
Query parameters must be specified in a STRUCT

statement error
SELECT * FROM mysql_query('s', 'SELECT ? col1',  params=row('2020-12-31 12:34:56'::TIMESTAMP_NS))
----
IO Error: Unsupported parameters type: "TIMESTAMP_NS", MySQL query "SELECT ? col1"

query II
SELECT col1, typeof(col1) FROM mysql_query('s', 'SELECT ? col1',
  params=row(42::TINYINT),
  stream_results=FALSE)
----
42	TINYINT

query II
SELECT col1, typeof(col1) FROM mysql_query('s', 'SELECT ? col1',
  params=row(42::TINYINT),
  stream_results=TRUE)
----
42	VARCHAR