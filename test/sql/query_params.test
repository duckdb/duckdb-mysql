# name: test/sql/query_params.test
# description: Test mysql_query with parameters
# group: [sql]

require mysql_scanner

require-env MYSQL_TEST_DATABASE_AVAILABLE

statement ok
ATTACH 'host=localhost user=root port=0 database=mysqlscanner' AS s (TYPE MYSQL_SCANNER)

query II
SELECT *, typeof(col1) FROM mysql_query('s', 'SELECT ? col1', params=row(NULL))
----
NULL	VARCHAR

# numbers

query II
SELECT * FROM mysql_query('s', 'SELECT ? col1, ? col2', params=row(TRUE, FALSE))
----
1	0

query III
SELECT * FROM mysql_query('s', 'SELECT ? col1, ? col2, ? col3', params=row(42::TINYINT, -127::TINYINT, 127::TINYINT))
----
42	-127	127

query III
SELECT * FROM mysql_query('s', 'SELECT ? col1, ? col2, ? col3', params=row(42::UTINYINT, 0::UTINYINT, 255::UTINYINT))
----
42	0	255

query III
SELECT * FROM mysql_query('s', 'SELECT ? col1, ? col2, ? col3', params=row(42::SMALLINT, -32767::SMALLINT, 32767::SMALLINT))
----
42	-32767	32767

query III
SELECT * FROM mysql_query('s', 'SELECT ? col1, ? col2, ? col3', params=row(42::USMALLINT, 0::USMALLINT, 65535::USMALLINT))
----
42	0	65535

query III
SELECT * FROM mysql_query('s', 'SELECT ? col1, ? col2, ? col3', params=row(42::INTEGER, -2147483647::INTEGER, 2147483647::INTEGER))
----
42	-2147483647	2147483647

query III
SELECT * FROM mysql_query('s', 'SELECT ? col1, ? col2, ? col3', params=row(42::UINTEGER, 0::UINTEGER, 4294967295::UINTEGER))
----
42	0	4294967295

query IIII
SELECT *, typeof(col1) FROM mysql_query('s', 'SELECT ? col1, ? col2, ? col3', params=row(42::BIGINT, -9223372036854775807::BIGINT, 9223372036854775807::BIGINT))
----
42	-9223372036854775807	9223372036854775807	BIGINT

query IIII
SELECT *, typeof(col1) FROM mysql_query('s', 'SELECT ? col1, ? col2, ? col3', params=row(42::UBIGINT, 0::UBIGINT, 18446744073709551615::UBIGINT))
----
42	0	18446744073709551615	UBIGINT

query III
SELECT * FROM mysql_query('s', 'SELECT ? col1, ? col2, ? col3', params=row(42::FLOAT, 0::FLOAT, 42.123::FLOAT))
----
42	0	42.123

query IIII
SELECT *, typeof(col1) FROM mysql_query('s', 'SELECT ? col1, ? col2, ? col3', params=row(42::DOUBLE, 0::DOUBLE, 42.123::DOUBLE))
----
42	0	42.123	DOUBLE

# dates

query II
SELECT *, typeof(col1) FROM mysql_query('s', 'SELECT ? col1',  params=row('2020-12-31'::DATE))
----
2020-12-31	DATE

query II
SELECT *, typeof(col1) FROM mysql_query('s', 'SELECT ? col1',  params=row('1970-01-01'::DATE))
----
1970-01-01	DATE

query II
SELECT *, typeof(col1) FROM mysql_query('s', 'SELECT ? col1',  params=row('0001-01-01'::DATE))
----
0001-01-01	DATE

statement ok
SET mysql_time_as_time = TRUE

query II
SELECT *, typeof(col1) FROM mysql_query('s', 'SELECT ? col1',  params=row('12:34:56.123'::TIME))
----
12:34:56.123	TIME

query II
SELECT *, typeof(col1) FROM mysql_query('s', 'SELECT ? col1',  params=row('00:00:01'::TIME))
----
00:00:01	TIME

statement ok
SET mysql_time_as_time = FALSE

query II
SELECT *, typeof(col1) FROM mysql_query('s', 'SELECT ? col1',  params=row('2020-12-31 12:34:56.123'::TIMESTAMP))
----
2020-12-31 12:34:56.123	TIMESTAMP

# require icu

# statement ok
# SET TimeZone='UTC'

# statement ok
# SET mysql_session_time_zone = '+01:00'

# query II
# SELECT *, typeof(col1) FROM mysql_query('s', 'SELECT ? col1',  params=row('2020-12-31 12:34:56.123-05:00'::TIMESTAMP WITH TIME ZONE))
# ----
# 2020-12-31 17:34:56.123+00	TIMESTAMP WITH TIME ZONE

# varchar

query II
SELECT *, typeof(col1) FROM mysql_query('s', 'SELECT ? col1',  params=row('foo'::VARCHAR))
----
foo	VARCHAR

query II
SELECT *, typeof(col1) FROM mysql_query('s', 'SELECT ? col1',  params=row('01234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789'::VARCHAR))
----
01234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789	VARCHAR

statement ok
PREPARE p1 as SELECT * from mysql_query('s', 'SELECT CONCAT(?, ?) a', params=row(?, ?))

query I
EXECUTE p1('foo', 'bar')
----
foobar

query I
EXECUTE p1('baz', 'boo')
----
bazboo

statement ok
DEALLOCATE p1

statement error
SELECT * FROM mysql_query('s', 'SELECT ? col1',  params=NULL)
----
Binder Error: Parameters to mysql_query cannot be NULL

statement error
SELECT * FROM mysql_query('s', 'SELECT ? col1',  params=42)
----
Query parameters must be specified in a STRUCT

statement error
SELECT * FROM mysql_query('s', 'SELECT ? col1',  params=row('2020-12-31 12:34:56'::TIMESTAMP_NS))
----
IO Error: Unsupported parameters type: "TIMESTAMP_NS", MySQL query "SELECT ? col1"
